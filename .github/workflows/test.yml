name: Run Pytest with Docker Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3

    - name: 🐳 Set up Docker Compose
      run: docker compose up -d db

    - name: 🕒 Wait for PostgreSQL to be ready
      run: |
        until docker exec $(docker ps -qf "name=db") pg_isready -U postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 1
        done

    - name: 🚀 Run tests
      run: docker compose run --rm test

    - name: 🧹 Clean up
      run: docker compose down --volumes
